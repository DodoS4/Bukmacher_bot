name: DEBUG-TEST-TELEGRAM

on:
  workflow_dispatch: # Pozwala na rÄ™czne uruchomienie przyciskiem "Run workflow"

jobs:
  debug-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Test Script
        env:
          # Tu wstrzykujemy sekrety do systemu
          T_TOKEN: ${{ secrets.T_TOKEN }}
          T_CHAT: ${{ secrets.T_CHAT }}
          ODDS_KEY: ${{ secrets.ODDS_KEY }}
        run: |
          # Tworzymy skrypt testowy bezpoÅ›rednio w locie
          echo '
          import os
          import requests

          def run_debug():
              print("--- DIAGNOSTYKA START ---")
              
              token = os.environ.get("T_TOKEN")
              chat = os.environ.get("T_CHAT")
              api = os.environ.get("ODDS_KEY")

              print(f"1. ODDS_KEY: {"âœ… OK" if api else "âŒ BRAK"}")
              print(f"2. T_TOKEN: {"âœ… OK" if token else "âŒ BRAK"}")
              print(f"3. T_CHAT:  {"âœ… OK" if chat else "âŒ BRAK"}")

              if not token or not chat:
                  print("\nâ— BÅÄ„D: GitHub nie przekazuje sekretÃ³w. SprawdÅº Settings -> Secrets.")
                  return

              print("\nðŸ“¡ PrÃ³ba poÅ‚Ä…czenia z API Telegram...")
              test_url = f"https://api.telegram.org/bot{token}/getMe"
              try:
                  res = requests.get(test_url, timeout=10).json()
                  if res.get("ok"):
                      print(f"âœ… PoÅ‚Ä…czono z botem: @{res['"result"']['"username"']}")
                      
                      print("ðŸ“¤ WysyÅ‚anie wiadomoÅ›ci testowej...")
                      msg_url = f"https://api.telegram.org/bot{token}/sendMessage"
                      msg_res = requests.post(msg_url, json={
                          "chat_id": chat,
                          "text": "ðŸ¤– TEST: Bot Dawida nawiÄ…zaÅ‚ poÅ‚Ä…czenie z GitHubem!"
                      }).json()
                      
                      if msg_res.get("ok"):
                          print("ðŸŽ‰ SUKCES! WiadomoÅ›Ä‡ powinna byÄ‡ na Twoim telefonie.")
                      else:
                          print(f"âŒ Telegram odrzuciÅ‚ wiadomoÅ›Ä‡: {msg_res}")
                  else:
                      print(f"âŒ BÅ‚Ä…d Tokena: {res}")
              except Exception as e:
                  print(f"âŒ BÅ‚Ä…d sieciowy: {e}")

          run_debug()
          ' > final_test.py
          
          python final_test.py
