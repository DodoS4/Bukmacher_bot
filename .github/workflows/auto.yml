name: DEBUG-TEST-V2

on:
  workflow_dispatch: 

jobs:
  debug-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Test Script
        env:
          T_TOKEN: ${{ secrets.T_TOKEN }}
          T_CHAT: ${{ secrets.T_CHAT }}
          ODDS_KEY: ${{ secrets.ODDS_KEY }}
        run: |
          # Tworzymy skrypt bez emoji, żeby uniknąć SyntaxError
          cat << 'EOF' > final_test.py
          import os
          import requests

          def run_debug():
              print("--- START DIAGNOSTYKI ---")
              
              token = os.environ.get("T_TOKEN")
              chat = os.environ.get("T_CHAT")
              api = os.environ.get("ODDS_KEY")

              print(f"1. ODDS_KEY: {'OK' if api else 'BRAK'}")
              print(f"2. T_TOKEN: {'OK' if token else 'BRAK'}")
              print(f"3. T_CHAT:  {'OK' if chat else 'BRAK'}")

              if not token or not chat:
                  print("\nBLAD: GitHub nie przekazuje sekretów!")
                  return

              test_url = f"https://api.telegram.org/bot{token}/getMe"
              try:
                  res = requests.get(test_url, timeout=10).json()
                  if res.get("ok"):
                      print(f"Polaczono z botem: @{res['result']['username']}")
                      
                      msg_url = f"https://api.telegram.org/bot{token}/sendMessage"
                      msg_res = requests.post(msg_url, json={
                          "chat_id": chat,
                          "text": "TEST: Polaczenie nawiazane!"
                      }).json()
                      
                      if msg_res.get("ok"):
                          print("SUKCES! Sprawdz Telegram.")
                      else:
                          print(f"Telegram odrzucil wiadomosc: {msg_res}")
                  else:
                      print(f"Blad Tokena: {res}")
              except Exception as e:
                  print(f"Blad sieciowy: {e}")

          run_debug()
          EOF
          
          python final_test.py
