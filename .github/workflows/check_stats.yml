import os
import json
from datetime import datetime, timedelta, timezone
from collections import defaultdict
from dateutil import parser
import requests

# ================= CONFIG =================
T_TOKEN = os.getenv("T_TOKEN")
T_CHAT_RESULTS = os.getenv("T_CHAT_RESULTS")

COUPONS_FILE = "coupons.json"
BANKROLL_FILE = "bankroll.json"

LEAGUE_INFO = {
    "basketball_nba": {"name": "NBA", "flag": "ğŸ€"},
    "soccer_epl": {"name": "Premier League", "flag": "âš½ PL"},
    "icehockey_nhl": {"name": "NHL", "flag": "ğŸ’"},
    "soccer_poland_ekstraklasa": {"name": "Ekstraklasa", "flag": "âš½ EK"},
    "soccer_uefa_champs_league": {"name": "Champions League", "flag": "ğŸ† CL"}
}

# ================= FILE UTILS =================
def load_json(path, default):
    if os.path.exists(path):
        try:
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
        except:
            pass
    return default

def load_bankroll():
    return load_json(BANKROLL_FILE, {}).get("bankroll", 100.0)

# ================= TELEGRAM =================
def send_msg(text):
    if not T_TOKEN or not T_CHAT_RESULTS:
        return
    try:
        requests.post(
            f"https://api.telegram.org/bot{T_TOKEN}/sendMessage",
            json={
                "chat_id": T_CHAT_RESULTS,
                "text": text,
                "parse_mode": "HTML",
                "disable_web_page_preview": True
            },
            timeout=10
        )
    except:
        pass

# ================= STATS =================
def send_stats():
    coupons = load_json(COUPONS_FILE, [])
    bankroll = load_bankroll()
    now = datetime.now(timezone.utc)

    def calc_league_stats(c_list):
        stats = defaultdict(lambda: {"types":0,"won":0,"lost":0})
        for c in c_list:
            stats[c["league"]]["types"] += 1
            stats[c["league"]]["won"] += c.get("win_val",0)
            if c["status"]=="lost":
                stats[c["league"]]["lost"] += c.get("stake",0)
        return stats

    def format_compact_stats(stats_dict):
        msg = ""
        best_league = None
        best_profit = float('-inf')
        for league, data in stats_dict.items():
            profit = data["won"] - data["lost"]
            if profit > best_profit:
                best_profit = profit
                best_league = league
            info = LEAGUE_INFO.get(league, {"flag":"ğŸ¯","name":league})
            msg += f"{info['flag']} {info['name']}: {data['types']} typÃ³w | ğŸŸ¢ {round(data['won'],2)} | ğŸ”´ {round(data['lost'],2)} | ğŸ’ {round(profit,2)}\n"
        return msg, best_league, best_profit

    # --- DZIENNE ---
    today_coupons = [c for c in coupons if c.get("sent_date") == str(now.date())]
    if today_coupons:
        stats = calc_league_stats(today_coupons)
        stats_msg, best_league, best_profit = format_compact_stats(stats)
        send_msg(f"ğŸ“Š <b>Statystyki dzienne</b> | {str(now.date())}\nğŸ’° Bankroll: {round(bankroll,2)} PLN\n\n{stats_msg}ğŸ† Najbardziej dochodowa liga: {LEAGUE_INFO.get(best_league,{'name':best_league})['name']} ({round(best_profit,2)} PLN)")

    # --- TYGODNIOWE ---
    if now.weekday() == 6:  # niedziela
        week_coupons = [c for c in coupons if parser.isoparse(c.get("sent_date")).isocalendar()[1] == now.isocalendar()[1]]
        if week_coupons:
            stats = calc_league_stats(week_coupons)
            stats_msg, best_league, best_profit = format_compact_stats(stats)
            send_msg(f"ğŸ“Š <b>Statystyki tygodniowe</b> | tydzieÅ„: {now.isocalendar()[1]}\nğŸ’° Bankroll: {round(bankroll,2)} PLN\n\n{stats_msg}ğŸ† Najbardziej dochodowa liga: {LEAGUE_INFO.get(best_league,{'name':best_league})['name']} ({round(best_profit,2)} PLN)")

    # --- MIESIÄ˜CZNE ---
    tomorrow = now + timedelta(days=1)
    if tomorrow.day == 1:  # ostatni dzieÅ„ miesiÄ…ca
        month_coupons = [c for c in coupons if parser.isoparse(c.get("sent_date")).month == now.month]
        if month_coupons:
            stats = calc_league_stats(month_coupons)
            stats_msg, best_league, best_profit = format_compact_stats(stats)
            send_msg(f"ğŸ“Š <b>Statystyki miesiÄ™czne</b> | miesiÄ…c: {now.month}\nğŸ’° Bankroll: {round(bankroll,2)} PLN\n\n{stats_msg}ğŸ† Najbardziej dochodowa liga: {LEAGUE_INFO.get(best_league,{'name':best_league})['name']} ({round(best_profit,2)} PLN)")

# ================= MAIN =================
if __name__ == "__main__":
    send_stats()