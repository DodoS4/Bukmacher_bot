<script>
    let profitChart = null;
    let countdown = 300;

    async function loadData() {
        try {
            // Dodajemy znacznik czasu, aby uniknąć czytania starej wersji z pamięci przeglądarki
            const response = await fetch('stats.json?v=' + Date.now());
            const s = await response.json();
            
            console.log("Dane wczytane:", s); // Pomocnicze logowanie w konsoli

            // MAPOWANIE DANYCH (Musi być identyczne jak w stats.json)
            document.getElementById('total-profit').innerText = (s.zysk_total || 0).toFixed(2) + ' PLN';
            document.getElementById('today-profit').innerText = (s.zysk_24h || 0).toFixed(2) + ' PLN';
            
            // Fioletowa karta (Bankroll)
            const bankrollEl = document.getElementById('roi-val');
            if (bankrollEl) bankrollEl.innerText = (s.bankroll || 0).toFixed(2) + ' PLN';

            document.getElementById('turnover-val').innerText = s.obrot || 0;
            document.getElementById('yield-val').innerText = (s.yield || 0) + '%';
            document.getElementById('upcoming-val').innerText = s.upcoming_val || 0;
            document.getElementById('total-bets-count').innerText = s.total_bets_count || 0;
            document.getElementById('last-update').innerText = 'Sync: ' + (s.last_sync || '--:--');

            // Wczytywanie historii dla wykresu i listy
            const hRes = await fetch('history.json?v=' + Date.now());
            const history = await hRes.json();
            
            renderHistory(history, s.wykres || []);
        } catch (e) { 
            console.error("Błąd ładowania danych:", e); 
        }
    }

    function renderHistory(data, chartPoints) {
        // Wykres
        const ctx = document.getElementById('profitChart').getContext('2d');
        if(profitChart) profitChart.destroy();
        
        profitChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: chartPoints.map((_, i) => i), 
                datasets: [{ 
                    data: chartPoints, 
                    borderColor: '#2563eb', 
                    borderWidth: 2, 
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    pointRadius: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
            }
        });

        // Lista ostatnich rozliczeń
        const recentContainer = document.getElementById('recent-results-container');
        if (recentContainer) {
            const last10 = [...data].reverse().slice(0, 10);
            recentContainer.innerHTML = last10.map(m => `
                <div class="flex justify-between items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm ${m.status === 'WIN' ? 'win-border' : 'loss-border'}">
                    <div>
                        <p class="text-[7px] text-gray-400 font-bold uppercase">@${m.odds} | ${m.score || '?-?'}</p>
                        <p class="text-[9px] font-bold text-slate-700">${m.home} - ${m.away}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-black ${m.profit > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${m.profit > 0 ? '+' : ''}${m.profit.toFixed(2)}
                        </p>
                    </div>
                </div>
            `).join('');
        }
    }

    // Odświeżanie licznika
    setInterval(() => { 
        countdown--; 
        document.getElementById('refresh-timer').innerText = `REF: ${countdown}s`; 
        if(countdown <= 0) { loadData(); countdown = 300; } 
    }, 1000);

    // Pierwsze wczytanie
    loadData();
</script>
